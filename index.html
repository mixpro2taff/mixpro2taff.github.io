<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PIXEL QUEST - Synchronized</title>
    <style>
        :root {
            --bg-color: #08080c;
            --card-bg: #111116;
            --accent: #f1c40f;
        }

        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            user-select: none;
        }

        #start-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .stats-bar {
            display: flex; justify-content: space-around; width: 950px;
            border: 4px double #fff; padding: 15px; background: #000; margin-bottom: 20px;
        }
        .stat-item { text-align: center; flex: 1; }
        .stat-label { font-size: 0.7em; color: #888; text-transform: uppercase; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: var(--accent); }
        .boutique-tab-btn { position: fixed; bottom: 20px; left: 20px; border-color: #9b59b6; color: #9b59b6; z-index: 999; }

        #game-screen {
            width: 950px; height: 350px; background: #000; border: 2px solid #222;
            padding: 20px; overflow-y: auto; box-sizing: border-box; margin-bottom: 20px;
        }

        #merchant-area {
            display: none; width: 950px; background: #050505; border: 2px dashed var(--accent);
            padding: 20px; box-sizing: border-box; text-align: center; margin-bottom: 20px;
        }

        .cards-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        
        .item-card {
            background: var(--card-bg);
            border: 2px solid #333;
            padding: 12px;
            width: 180px;
            min-height: 220px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            text-align: left;
        }
        .item-card:hover { transform: translateY(-5px); background: #000; }

        .rarity-commun:hover { border-color: #95a5a6; box-shadow: 0 0 15px #95a5a6; }
        .rarity-rare:hover { border-color: #3498db; box-shadow: 0 0 15px #3498db; }
        .rarity-legendaire:hover { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        .rarity-ultra:hover { border-color: #9b59b6; box-shadow: 0 0 15px #9b59b6; }
        .rarity-intel:hover { border-color: #2ecc71; box-shadow: 0 0 15px #2ecc71; }
        .rarity-cheat:hover { border-color: #e74c3c; box-shadow: 0 0 25px #e74c3c; }

        .card-name { font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.9em; color: #fff; }
        .card-stats { flex-grow: 1; font-size: 0.75em; line-height: 1.4; color: #bbb; }
        .card-stats span { color: #2ecc71; }
        .card-capa { color: #e67e22; font-style: italic; margin-top: 5px; font-size: 0.85em; }
        .owned-tag { color: #2ecc71; font-weight: bold; font-size: 0.7em; margin-top: 5px; }

        #codex-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 1000;
            padding: 40px; box-sizing: border-box; overflow-y: auto;
        }
        .possessed-card { border-color: #2ecc71 !important; box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.2); }

        .btn {
            background: #000; color: #fff; border: 2px solid #fff;
            padding: 10px 20px; cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .btn:hover { background: #fff; color: #000; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .codex-tab-btn { position: fixed; bottom: 20px; right: 20px; border-color: var(--accent); color: var(--accent); }
        .log-entry { margin-bottom: 5px; border-left: 2px solid #333; padding-left: 10px; font-size: 0.9em; }
        #collection-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.98);
    z-index: 3000;
    padding: 40px;
    box-sizing: border-box;
    overflow-y: auto;
}

.collection-card {
    background: var(--card-bg);
    border: 2px solid #333;
    padding: 12px;
    width: 180px;
    min-height: 220px;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    opacity: 0.3;
    filter: grayscale(100%);
}

.collection-card.owned {
    opacity: 1;
    filter: grayscale(0%);
}

.collection-card.owned:hover {
    transform: translateY(-5px);
    background: #000;
}

.collection-card.selected {
    opacity: 1 !important;
    filter: grayscale(0%) !important;
}

.collection-card.selected.rarity-commun {
    border-color: #95a5a6;
    box-shadow: 0 0 20px #95a5a6;
}

.collection-card.selected.rarity-rare {
    border-color: #3498db;
    box-shadow: 0 0 20px #3498db;
}

.collection-card.selected.rarity-legendaire {
    border-color: #f1c40f;
    box-shadow: 0 0 20px #f1c40f;
}

.collection-card.selected.rarity-ultra {
    border-color: #9b59b6;
    box-shadow: 0 0 20px #9b59b6;
}

.collection-card.selected.rarity-intel {
    border-color: #2ecc71;
    box-shadow: 0 0 20px #2ecc71;
}

.collection-card.selected.rarity-cheat {
    border-color: #e74c3c;
    box-shadow: 0 0 25px #e74c3c;
}

.card-count {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.8);
    color: #fff;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.7em;
    font-weight: bold;
}

.selected-indicator {
    position: absolute;
    top: 5px;
    left: 5px;
    background: var(--accent);
    color: #000;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.7em;
    font-weight: bold;
}
    </style>
</head>
<body>

    <div id="start-menu">
    <h1 style="color: var(--accent); font-size: 4em;">PIXEL QUEST</h1>
    <p>S√âLECTIONNE TA DIFFICULT√â</p>
    <div style="margin-top: 20px;">
       <button class="btn" onclick="startGame('facile')">FACILE (Or x1.5)</button>
       <button class="btn" onclick="startGame('normal')" style="margin: 0 15px;">NORMAL</button>
       <button class="btn" onclick="startGame('difficile')">DIFFICILE (Ennemis x1.5)</button>
    </div>
    <div style="margin-top: 10px;">
       <button class="btn" onclick="startGame('impossible')" style="border-color: #e74c3c; color: #e74c3c;">IMPOSSIBLE (Ennemis x2)</button>
       <button class="btn" onclick="startGame('enfer')" style="margin-left: 15px; border-color: #8e44ad; color: #8e44ad;">ENFER (Ennemis x3, Boss x1.5)</button>
    </div>
    <div style="margin-top: 30px;">
        <button class="btn" onclick="openCollection()" style="border-color: #9b59b6; color: #9b59b6;">
            üì¶ COLLECTION (<span id="selected-count">0</span>/3)
        </button>
    </div>
</div>

    <div class="stats-bar">
        <div class="stat-item"><div class="stat-label">Jour</div><div id="stat-jour" class="stat-value">1</div></div>
        <div class="stat-item"><div class="stat-label">Sant√©</div><div id="stat-pv" class="stat-value" style="color:#ff4757">100</div></div>
        <div class="stat-item"><div class="stat-label">Or</div><div id="stat-or" class="stat-value">40</div></div>
        <div class="stat-item"><div class="stat-label">Attaque</div><div id="stat-att" class="stat-value">8</div></div>
        <div class="stat-item"><div class="stat-label">D√©fense</div><div id="stat-def" class="stat-value">3.00</div></div>
        <div class="stat-item"><div class="stat-label">Regen</div><div id="stat-regen" class="stat-value">20</div></div>
        <div class="stat-item"><div class="stat-label">Intel</div><div id="stat-int" class="stat-value">0</div></div>
        <div class="stat-item"><div class="stat-label">Gemmes</div><div id="stat-gemmes" class="stat-value">0</div></div>
    </div>

    <div id="game-screen"></div>

    <div id="merchant-area">
        <h2 style="margin:0 0 15px 0;">üõí MARCHAND</h2>
        <div id="merchant-cards" class="cards-container"></div>
        <button class="btn" onclick="finishDay()" style="margin-top: 15px; border-color: var(--accent);">Continuer</button>
    </div>

    <button id="btn-next" class="btn" onclick="playTurn()" style="width: 950px; font-size: 1.4em;">Lancer Jour 1</button>
    <button class="btn codex-tab-btn" onclick="toggleCodex(true)">üìñ CODEX</button>
    <button class="btn boutique-tab-btn" onclick="toggleBoutique(true)">üíé BOUTIQUE</button>

    <div id="codex-overlay">
        <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px;">
            <h1 style="margin:0; color:var(--accent);">CODEX</h1>
            <button class="btn" onclick="toggleCodex(false)">FERMER ‚úñ</button>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="tab-objets" onclick="switchCodexTab('objets')" style="border-color: var(--accent); background: var(--accent); color: #000;">üì¶ OBJETS</button>
            <button class="btn" id="tab-events" onclick="switchCodexTab('events')">üé≤ EVENTS</button>
        </div>
        
        <div id="codex-objets-content">
            <h3 style="color:#2ecc71;">‚òÖ CAPACIT√âS : <span id="my-capas-list" style="color:#fff; font-size: 0.8em;">Aucune</span></h3>
            <hr style="border:0; border-top:1px solid #333; margin: 20px 0;">
            <div id="codex-grid" class="cards-container"></div>
        </div>
        
        <div id="codex-events-content" style="display: none;">
            <div id="events-grid"></div>
        </div>
    </div>

<script>
// ======================
// CONFIG & DATA
// ======================
const DEF_MIN = 0.2;
let jour = 1;
let diffSetting = { name: 'NORMAL', gold: 1, enemy: 1, boss: 1 };
let joueur = { intelligence: 0, pv: 100, att: 8, def: 3, or: 40, regen: 20, capas: [] , gemmes: 0};
let permanentUpgrades = JSON.parse(localStorage.getItem('pixelquest_upgrades') || '{"pv":0,"att":0,"def":0,"or":0,"regen":0}');
let upgradesCost = JSON.parse(localStorage.getItem('pixelquest_costs') || '{"pv":10,"att":10,"def":10,"or":10,"regen":10}');
// CHARGER LA S√âLECTION D'OBJETS AU D√âMARRAGE DE LA PAGE
// CHARGER LA S√âLECTION D'OBJETS AU D√âMARRAGE DE LA PAGE

function loadSelectedItems() {
    const savedItems = JSON.parse(localStorage.getItem('pixelquest_selected_items') || '[]');
    const inventory = JSON.parse(localStorage.getItem('pixelquest_inventory') || '[]');
    
    selectedCollectionItems = [];
    savedItems.forEach(savedItem => {
        let slotIndex = 0;
        inventory.forEach((invItem) => {
            if(invItem.nom === savedItem.nom && selectedCollectionItems.filter(s => s.item.nom === savedItem.nom).length === slotIndex) {
                selectedCollectionItems.push({
                    key: `${savedItem.nom}-${slotIndex}`,
                    item: savedItem
                });
                slotIndex++;
            }
        });
    });
    
    // Mettre √† jour l'affichage du compteur dans le menu
    if(document.getElementById('selected-count')) {
        document.getElementById('selected-count').innerText = selectedCollectionItems.length;
    }
}

// Charger au d√©marrage quand le DOM est pr√™t
window.addEventListener('DOMContentLoaded', function() {
    loadSelectedItems();
});

const oCommuns = [
    {nom: "√âp√©e rouill√©e", att: 3, r:"commun"},
    {nom: "Casque simple", pv: 8, r:"commun"},
    {nom: "Anneau magique us√©", def: -0.1, r:"commun"},
    {nom: "Lance", att: 4, r:"commun"},
    {nom: "B√¢ton magique", att: 2, regen: 1, r:"commun"},
    {nom: "Buff commun", att: 2, pv: 5, def: -0.05, r:"commun"},
    {nom: "Bouclier", def: -0.1, pv: 5, r:"commun"},
    {nom: "Buff evo commun", att: 4, pv: 10, regen: 1, def: -0.1, r:"commun"}
];

const oRares = [
    {nom: "√âp√©e fine", att: 8, r:"rare"},
    {nom: "Armure renforc√©e", def: -0.2, pv: 10, r:"rare"},
    {nom: "Amulette vitale", pv: 20, r:"rare"},
    {nom: "Anneau de pouvoir", pv: 10, att: 5, r:"rare"},
    {nom: "Colt 1911", att: 10, r:"rare"},
    {nom: "Buff rare", att: 4, pv: 10, def: -0.1, r:"rare"},
    {nom: "M4", att: 18, r:"rare"},
    {nom: "Buff evo rare", att: 8, pv: 20, def: -0.2, regen: 2, r:"rare"},
    {nom: "Livre tactique", att: 8, intelligence: 5, r:"rare"}
];

const oLeg = [
    {nom: "Lame mythique", att: 95, r:"legendaire"},
    {nom: "Armure enchant√©e", pv: 70, def: -0.25, regen: 10, r:"legendaire"},
    {nom: "Coeur du h√©ros", pv: 50, capa: "vol_de_vie", r:"legendaire"},
    {nom: "Carapace absolue", pv: 70, capa: "reduc_degats", r:"legendaire"},
    {nom: "Lames fr√©n√©tiques", att: 45, capa: "multi_attaque", r:"legendaire"},
    {nom: "Buff legendaire", att: 30, pv: 50, def: -0.3, regen: 8, r:"legendaire"},
    {nom: "Savoir continu", intelligence: 10, capa: "ia", r:"legendaire"}
];

const oUltra = [
    {nom: "Bouclier invincible", pv: 120, def: -0.5, capa: "invincible_3tour", r:"ultra"},
    {nom: "Gantelet de puissance", att: 90, capa: "crit_25", r:"ultra"},
    {nom: "Tenu de camouflage ultime", pv: 80, def: -0.4, capa: "esquive_total", r:"ultra"},
    {nom: "Buff ultime", pv: 125, def: -0.6, att: 50, regen: 15, r:"ultra"},
    {nom: "Source du savoir", intelligence: 15, capa: "raisonnement", r:"ultra"},
    {nom: "Negociant", capa: "investissement", r:"ultra"}
];

const oIntel = [
    {nom: "Cerveau moisi", intelligence: 1, r:"intel"},
    {nom: "Livre pas ouf", intelligence: 2, r:"intel"},
    {nom: "Livre carr√©", intelligence: 5, r:"intel"},
    {nom: "Grimoire qui date", intelligence: 3, r:"intel"},
    {nom: "Livre du savoir", intelligence: 7, r:"intel"}
];

const oCheat = [
    {nom: "(Mahe) Rat divin", capa: "loot+", r:"cheat"},
    {nom: "Buff divin", pv: 300, att: 150, def: -1, regen: 30, r:"cheat"},
    {nom: "Lumiere divine", att: 100, capa: "extermination", r:"cheat"},
    {nom: "Miroir de l'√¢me", capa: "reflect_50", r:"cheat"}
];

const oMarchandExclusif = [
    {nom: "√âlixir ancestral", pv: 30, regen: 6, r:"rare"},
    {nom: "Couronne du sage", intelligence: 45, def: -0.2, att: 25, r:"legendaire"},
    {nom: "Cape d'invisibilit√©", def: -0.4, pv: 80, capa: "phase", r:"ultra"},
    {nom: "Grimoire interdit", intelligence: 10, att: 35, r:"legendaire"},
    {nom: "Anneau du ph√©nix", pv: 25, regen: 10, r:"rare"},
    {nom: "Lame du voyageur", att: 35, r:"rare"},
    {nom: "Pierre philosophale",def: -0.2, pv: 50, regen: 8, capa: "alchimie", r:"ultra"},
    {nom: "M√©daillon du destin", pv: 40, att: 15, def: -0.20, intelligence: 5, r:"legendaire"}
];

const ALL_ITEMS = [...oCommuns, ...oRares, ...oLeg, ...oUltra, ...oIntel, ...oCheat, ...oMarchandExclusif];

const ennemisBase = {
    voleur: {nom: "Voleur", pv: 60, att: 6, def: 2, or: 10},
    guerrier: {nom: "Guerrier", pv: 100, att: 8, def: 1.8, or: 20},
    champion: {nom: "Champion", pv: 200, att: 20, def: 1.5, or: 30},
    assassin: {nom: "Assassin", pv: 80, att: 15, def: 2, or: 20},
    mage: {nom: "Mage noir", pv: 100, att: 30, def: 1, or: 30},
    berserker: {nom: "Berserker", pv: 120, att: 15, def: 1.5, or: 20},
    paladin: {nom: "Paladin corrompu", pv: 250, att: 10, def: 0.6, or: 20, gemmes: 1},
    necromancien: {nom: "N√©cromancien", pv: 200, att: 20, def: 1, or: 30, gemmes: 1},
    dragon: {nom: "Dragon sauvage", pv: 400, att: 40, def: 1.2, or: 40, gemmes: 2},
    titan: {nom: "Titan de pierre", pv: 500, att: 35, def: 0.8, or: 40, gemmes: 2},
    creature : {nom : "Cr√©ature d√©moniaque", pv: 1000, att: 100, def: 0.5, or: 50, gemmes: 4},
    demon : {nom : "D√©mon", pv: 1500, att: 150, def:0.5, or:60, gemmes: 6},
    boss10: {nom: "Seigneur de fer", pv: 450, att: 25, def: 1, or: 30, gemmes: 1},
    boss20: {nom: "Roi du Nord", pv: 2500, att: 80, def: 0.5, or: 40, gemmes: 3},
    boss30: {nom: "Roi du monde", pv: 5500, att: 250, def: 0.3, or: 60, gemmes: 6},
    boss40: {nom: "Prince solaire", pv: 12000, att: 450, def: 0.20, or: 80, gemmes: 9},
    boss50: {nom: "Roi de la galaxie", pv: 20000, att: 600, def: 0.10, or: 90, gemmes: 12},
    boss60: {nom: "Dictateur inter-galaxie", pv: 35000, att: 900, def: 0.1, or: 100, gemmes: 18}
};

// ======================
// HELPERS
// ======================
const randint = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
const choice = (arr) => arr[Math.floor(Math.random() * arr.length)];

function ennemi_elite(e) {
    return {
        nom: "√âlite " + e.nom,
        pv: Math.floor(e.pv * 2),
        att: Math.floor(e.att * 2),
        def: Math.max(0.1, e.def / 2),
        or: e.or,
        gemmes: e.gemmes || 0
    };
}

function ennemi_elite2(e) {
    return {
        nom: "SUPER " + e.nom,
        pv: Math.floor(e.pv * 4),
        att: Math.floor(e.att * 4),
        def: Math.max(0.1, e.def / 2),
        or: e.or,
        gemmes: e.gemmes || 0
    };
}

function ennemi_elite3(e) {
    return {
        nom: "ULTRA " + e.nom,
        pv: Math.floor(e.pv * 6),
        att: Math.floor(e.att * 6),
        def: Math.max(0.1, e.def / 2),
        or: e.or,
        gemmes: e.gemmes || 0
    };
}

// ======================
// SYST√àME DE GEMMES QUOTIDIENNES
// ======================
function checkDailyGems() {
    const today = new Date().toDateString();
    const lastClaim = localStorage.getItem('pixelquest_last_daily_claim');
    const lastTimestamp = parseInt(localStorage.getItem('pixelquest_last_timestamp') || '0');
    const currentTimestamp = Date.now();
    
    if(currentTimestamp < lastTimestamp) {
        log("‚ö†Ô∏è D√©tection de modification de l'heure syst√®me !", "#e74c3c");
        localStorage.setItem('pixelquest_last_timestamp', currentTimestamp.toString());
        return;
    }
    
    if(lastClaim !== today) {
        joueur.gemmes += 100000000;
        localStorage.setItem('pixelquest_gemmes', joueur.gemmes.toString());
        localStorage.setItem('pixelquest_last_daily_claim', today);
        localStorage.setItem('pixelquest_last_timestamp', currentTimestamp.toString());
        
        log("üéÅ BONUS QUOTIDIEN : +10 üíé gemmes !", "#9b59b6");
        updateUI();
    } else {
        localStorage.setItem('pixelquest_last_timestamp', currentTimestamp.toString());
    }
}

// ======================
// UI
// ======================
function startGame(mode) {
    document.getElementById('collection-overlay').style.display = 'none';
    if(mode === 'facile') diffSetting = { name: 'FACILE', gold: 1.5, enemy: 1, boss: 1 };
    if(mode === 'normal') diffSetting = { name: 'NORMAL', gold: 1, enemy: 1, boss: 1 };
    if(mode === 'difficile') diffSetting = { name: 'DIFFICILE', gold: 1, enemy: 1.5, boss: 1.25 };
    if(mode === 'impossible') diffSetting = { name: 'IMPOSSIBLE', gold: 1, enemy: 2, boss: 1.25 };
    if(mode === 'enfer') diffSetting = { name: 'ENFER', gold: 1, enemy: 3, boss: 1.5 };
    
    joueur.gemmes = parseInt(localStorage.getItem('pixelquest_gemmes') || '0');
    checkDailyGems();
    
    // Appliquer les upgrades permanents
    joueur.pv += permanentUpgrades.pv;
    joueur.att += permanentUpgrades.att;
    joueur.def -= permanentUpgrades.def;
    joueur.or += permanentUpgrades.or;
    joueur.regen += permanentUpgrades.regen;

    // CHARGER ET APPLIQUER LES OBJETS S√âLECTIONN√âS
    // CHARGER ET APPLIQUER LES OBJETS S√âLECTIONN√âS
    const selectedItems = JSON.parse(localStorage.getItem('pixelquest_selected_items') || '[]');
    if(selectedItems.length > 0) {
        log("üéÅ Objets de d√©part :", "#9b59b6");
        selectedItems.forEach(item => {
            // Retirer l'objet des pools AVANT de l'appliquer
            if(item.r === "legendaire" || item.r === "ultra" || item.r === "cheat") {
                const allPools = [oLeg, oUltra, oCheat, oMarchandExclusif];
                allPools.forEach(pool => {
                    const idx = pool.findIndex(o => o.nom === item.nom);
                    if(idx > -1) pool.splice(idx, 1);
                });
            }
            appliquer_objet(item);
        });
    }
    
    document.getElementById('start-menu').style.display = 'none';
    log("‚öôÔ∏è Difficult√© : " + diffSetting.name, "#f1c40f");
    if(permanentUpgrades.pv > 0 || permanentUpgrades.att > 0 || permanentUpgrades.def > 0 || permanentUpgrades.or > 0 || permanentUpgrades.regen > 0) {
        log("üíé Am√©liorations permanentes actives !", "#9b59b6");
    }
    updateUI();
}
function updateUI() {
    document.getElementById('stat-jour').innerText = jour;
    document.getElementById('stat-pv').innerText = Math.floor(joueur.pv);
    document.getElementById('stat-or').innerText = Math.floor(joueur.or);
    document.getElementById('stat-att').innerText = Math.floor(joueur.att);
    document.getElementById('stat-def').innerText = joueur.def.toFixed(2);
    document.getElementById('stat-regen').innerText = Math.floor(joueur.regen);
    document.getElementById('stat-int').innerText = joueur.intelligence;
    document.getElementById('stat-gemmes').innerText = joueur.gemmes;
    document.getElementById('btn-next').innerText = "Lancer Jour " + jour;
}

function log(msg, color = "#fff") {
    const screen = document.getElementById('game-screen');
    const div = document.createElement('div');
    div.className = "log-entry";
    div.style.color = color;
    div.innerHTML = msg;
    screen.appendChild(div);
    screen.scrollTop = screen.scrollHeight;
}

// ======================
// APPLIQUER OBJET
// ======================
function appliquer_objet(obj) {
    log("‚ú® Objet acquis : " + obj.nom, "#3498db");
    for (let s in obj) {
        if (["nom", "r"].includes(s)) continue;
        if (s === "capa") { 
            if(!joueur.capas.includes(obj[s])) {
                joueur.capas.push(obj[s]);
                log("  ‚Üí Capacit√© obtenue : " + obj[s], "#e67e22");
            }
        } else { 
            joueur[s] += obj[s];
            if(s === "att") log("  ‚Üí Attaque +" + obj[s], "#2ecc71");
            if(s === "pv") log("  ‚Üí PV +" + obj[s], "#2ecc71");
            if(s === "def") log("  ‚Üí D√©fense " + (obj[s] > 0 ? "+" : "") + obj[s], "#2ecc71");
            if(s === "regen") log("  ‚Üí R√©g√©n√©ration +" + obj[s], "#2ecc71");
            if(s === "intelligence") log("  ‚Üí Intelligence +" + obj[s], "#2ecc71");
        }
    }
    joueur.def = Math.max(DEF_MIN, joueur.def);
    
    if(obj.r === "legendaire") {
        let idx = oLeg.indexOf(obj);
        if(idx > -1) oLeg.splice(idx, 1);
        idx = oMarchandExclusif.findIndex(o => o.nom === obj.nom);
        if(idx > -1) oMarchandExclusif.splice(idx, 1);
    }
    if(obj.r === "ultra") {
        let idx = oUltra.indexOf(obj);
        if(idx > -1) oUltra.splice(idx, 1);
        idx = oMarchandExclusif.findIndex(o => o.nom === obj.nom);
        if(idx > -1) oMarchandExclusif.splice(idx, 1);
    }
    if(obj.r === "cheat") {
        let idx = oCheat.indexOf(obj);
        if(idx > -1) oCheat.splice(idx, 1);
    }
    
    updateUI();
}

// ======================
// LOOT & PROBAS
// ======================
function loot_du_jour() {
    const probas = [
        [oCommuns, 1000], [oCommuns, 500], [oRares, 500],
        [oLeg, 30], [oUltra, 10], [oIntel, 250], [oCheat, 2]
    ];
    probas.forEach(([pool, chance]) => {
        if(randint(1, 1000) <= chance && pool.length > 0) {
            appliquer_objet(choice(pool));
        }
    });
}

// ======================
// EVENTS
// ======================
function event_piege() {
    log("‚ö†Ô∏è Tu avances dans un couloir sombre...");
    log("Un d√©clic sous ton pied ! Un pi√®ge !");
    if(joueur.intelligence >= jour) { 
        log("‚Üí Ton intelligence te permet de l'esquiver au dernier moment !", "#2ecc71");
        log("‚Üí Tu r√©cup√®res m√™me quelques pi√®ces pr√®s du m√©canisme : +10 or", "#f1c40f");
        joueur.or += 10; 
    } else { 
        let d = jour*2; 
        joueur.pv -= d;
        log("‚Üí Le pi√®ge se d√©clenche ! Tu perds " + d + " PV", "#e74c3c"); 
    }
    updateUI();
}

function event_piege_plus() {
    log("‚ö†Ô∏è‚ö†Ô∏è Le sol s'effondre sous tes pieds !");
    log("Un pi√®ge mortel se d√©clenche !");
    if(joueur.intelligence >= jour*2) { 
        log("‚Üí Gr√¢ce √† ton intelligence exceptionnelle, tu anticipes le danger !", "#2ecc71");
        log("‚Üí Tu explores la salle pi√©g√©e et trouves : +20 or", "#f1c40f");
        joueur.or += 20; 
    } else { 
        let d = jour*4; 
        joueur.pv -= d;
        log("‚Üí L'impact est brutal ! Tu perds " + d + " PV", "#e74c3c"); 
    }
    updateUI();
}

function event_gain() {
    log("üí∞ En explorant les environs, tu d√©couvres une bourse abandonn√©e !");
    log("‚Üí +10 or obtenus", "#f1c40f");
    joueur.or += 10;
    updateUI();
}

function event_gain_plus() {
    log("üí∞üí∞ Tu tombes sur un ancien campement de bandits...");
    log("Leur tr√©sor est encore l√† !");
    log("‚Üí +20 or obtenus", "#f1c40f");
    joueur.or += 20;
    updateUI();
}

function event_rencontre() {
    log("üòä Tu croises un groupe de voyageurs pacifiques autour d'un feu de camp.");
    log("Ils partagent leur nourriture avec toi.");
    log("‚Üí +10 PV r√©cup√©r√©s", "#2ecc71");
    joueur.pv += 10;
    updateUI();
}
function event_incroyable() {
    log("Tu trouve une ruine ancienne abritant des tr√©sors cach√©...");
    log("Tu d√©cide de rentrer");
    let ruine = randint(1,3);
    if (ruine > 1) {
        log("Le tr√©sor est bien mais tu esp√©rait mieux... +10 or et des objets");
        log("‚Üí +10 or obtenus", "#f1c40f");
        loot_du_jour();
        joueur.or += 10
    }
    if (ruine == 1) {
        log("Tu as trouv√© un tr√©sor incroyable");
        log("30 Or, 20 diamant, et des objets objets obtenu")
        log("‚Üí +30 or obtenus", "#f1c40f");
        log("üíé Tu obtient 20 gemmes");
        event_coffre_plus();
        joueur.or += 30;
        joueur.gemmes += 20;
        
    }
    
}
function event_chemin() {
    log("üõ§Ô∏è Tu arrives √† une intersection. Trois chemins s'offrent √† toi...");
    log("Le premier semble mener vers des ruines anciennes.");
    log("Le second traverse une for√™t dense.");
    log("Le troisi√®me longe une falaise escarp√©e.");
    let c = parseInt(prompt("Quel chemin prends-tu ? (1, 2 ou 3)"));
    if(isNaN(c) || c < 1 || c > 3) c = 2;
    let a = randint(1, 3);
    if(a == c) { 
        log("‚Üí Excellent choix ! Tu d√©couvres un coffre cach√© !", "#f1c40f"); 
        loot_du_jour(); 
    } else if(a > c) { 
        log("‚Üí Tu trouves une cache de brigands avec de l'or : +20 or", "#f1c40f"); 
        joueur.or += 20; 
    } else {
        log("‚Üí Le chemin √©tait vide... Tu continues ton voyage.", "#95a5a6");
    }
    updateUI();
}

function event_coffre() {
    log("üì¶ En fouillant les buissons, tu aper√ßois quelque chose qui brille...");
    log("Un coffre appara√Æt !");
    const probas = [
        [oCommuns, 1000], [oCommuns, 800], [oRares, 500],
        [oLeg, 30], [oIntel, 300]
    ];
    probas.forEach(([pool, chance]) => {
        if(randint(1, 1000) <= chance && pool.length > 0) {
            appliquer_objet(choice(pool));
        }
    });
}

function event_coffre_plus() {
    log("üì¶‚ú® Un √©clat magique attire ton attention au loin...");
    log("En t'approchant, tu d√©couvres un coffre orn√© de runes mystiques !");
    log("C'est un coffre rare !");
    const probas = [
        [oRares, 1000], [oRares, 800], [oLeg, 100],
        [oUltra, 40], [oIntel, 800], [oCheat, 10]
    ];
    probas.forEach(([pool, chance]) => {
        if(randint(1, 1000) <= chance && pool.length > 0) {
            appliquer_objet(choice(pool));
        }
    });
}
function event_gemmes() {
    log("En explorant les environs tu trouve une grotte");
    log("Dans la grotte, il y a des diamants, tu d√©cide d'en extraire");
    log("Tu r√©ussit a en prendre le maximum dans tes sac...");
    log("üíé Tu obtient 10 gemmes");
    joueur.gemmes += 10;
}

function event_gemmes_plus() {
    log("En explorant les environs tu trouve une grotte");
    log("La grotte est remplit de diamant, tu d√©cide d'en extraire");
    log("Tu r√©ussit a en prendre le maximum dans tes sac...");
    log("üíé Tu obtient 20 gemmes");
    joueur.gemmes += 20;
}
    
function event_pari() {
    log("üé≤ Tu tombes sur un groupe de voyageurs jouant √† des jeux d'argent.");
    log("L'ambiance est tendue. L'un d'eux te lance un d√©fi...");
    log("Tu d√©cides de participer √† une partie !");
    if(randint(1, 2) === 1) { 
        log("‚Üí Les d√©s roulent en ta faveur ! Tu remportes la mise !", "#2ecc71");
        log("‚Üí +20 or gagn√©s", "#f1c40f"); 
        joueur.or += 20; 
    } else { 
        log("‚Üí Malchance... Tu perds ta mise.", "#e74c3c");
        log("‚Üí -10 or perdus", "#e74c3c"); 
        joueur.or -= 10; 
    }
    updateUI();
}

function event_pari_plus() {
    log("üé≤‚ú® Un myst√©rieux joueur encapuchonn√© t'invite √† une partie sp√©ciale...");
    log("Les r√®gles semblent √™tre en ta faveur, mais le risque demeure.");
    log("Tu acceptes le d√©fi !");
    if(randint(1, 4) <= 3) { 
        log("‚Üí Victoire ! Le joueur reconna√Æt ta chance et te r√©compense !", "#2ecc71");
        log("‚Üí +20 or gagn√©s", "#f1c40f"); 
        joueur.or += 20; 
    } else { 
        log("‚Üí Contre toute attente, tu perds la partie...", "#e74c3c");
        log("‚Üí -10 or perdus", "#e74c3c"); 
        joueur.or -= 10; 
    }
    updateUI();
}

function jackpot() {
    log("üèÜ En explorant une grotte abandonn√©e, tu tombes sur une salle cach√©e...");
    log("Un TR√âSOR L√âGENDAIRE s'y trouve !");
    log("Des pi√®ces d'or partout, des gemmes pr√©cieuses...");
    log("‚Üí JACKPOT ! +40 or obtenus !", "#f1c40f");
    joueur.or += 40;
    updateUI();
}

function event_auberge() {
    log("üè† Apr√®s des heures de marche, tu aper√ßois une auberge accueillante.");
    log("L'odeur de nourriture chaude t'attire. L'aubergiste te propose ses services.");
    let choix = confirm("Payer 10 or pour un repos complet (+30 PV) ?\n(Annuler = repos simple gratuit +10 PV)");
    if(choix && joueur.or >= 10) {
        joueur.or -= 10;
        joueur.pv += 30;
        log("‚Üí Tu paies pour une chambre confortable et un festin.", "#2ecc71");
        log("‚Üí -10 or d√©pens√©s", "#e74c3c");
        log("‚Üí +30 PV r√©cup√©r√©s", "#2ecc71");
    } else if(choix) {
        log("‚Üí Tu n'as pas assez d'or pour le repos complet...", "#e74c3c");
    } else {
        joueur.pv += 10;
        log("‚Üí Tu dors dans l'√©curie. Ce n'est pas luxueux mais √ßa repose.", "#95a5a6");
        log("‚Üí +10 PV r√©cup√©r√©s", "#2ecc71");
    }
    updateUI();
}

function event_bibliotheque() {
    log("üìö Tu d√©couvres une biblioth√®que ancienne remplie de grimoires poussi√©reux.");
    log("Les connaissances contenues ici sont immenses, mais d√©chiffrer ces textes");
    log("anciens demande une concentration intense qui √©puise le corps...");
    let choix = confirm("√âtudier les grimoires ? (Co√ªte 15 PV pour +3 Intelligence)");
    if(choix && joueur.pv > 15) {
        joueur.pv -= 15;
        joueur.intelligence += 3;
        log("‚Üí Tu passes des heures √† d√©chiffrer les textes anciens.", "#9b59b6");
        log("‚Üí -15 PV (fatigue mentale)", "#e74c3c");
        log("‚Üí +3 Intelligence obtenus", "#2ecc71");
        updateUI();
    } else if(choix) {
        log("‚Üí Tu es trop affaibli pour √©tudier en s√©curit√©...", "#e74c3c");
    } else {
        log("‚Üí Tu pr√©f√®res garder tes forces. Sage d√©cision.", "#95a5a6");
    }
}

function event_enigme() {
    log("üß© Un sage myst√©rieux bloque ton chemin.");
    log("'R√©sous mon √©nigme et je te r√©compenserai', dit-il avec un sourire.");
    let reponse = parseInt(prompt("√ânigme : Combien font 7 + (jour actuel √ó 2) - jour ?\n(Le jour actuel est : " + jour + ")"));
    let solution = 7 + (jour * 2) - jour;
    
    if(reponse === solution) {
        log("‚Üí 'Excellent !' s'exclame le sage. 'Voici ta r√©compense !'", "#2ecc71");
        log("‚Üí +20 or obtenus", "#f1c40f");
        log("‚Üí +2 Intelligence (apprentissage)", "#9b59b6");
        joueur.or += 20;
        joueur.intelligence += 2;
        updateUI();
    } else if(joueur.intelligence >= jour * 1.5) {
        log("‚Üí Ta r√©ponse est fausse, mais le sage est impressionn√© par ton intelligence.", "#f39c12");
        log("‚Üí Il te donne une petite r√©compense : +10 or", "#f1c40f");
        joueur.or += 10;
        updateUI();
    } else {
        log("‚Üí 'Dommage...' Le sage dispara√Æt dans un nuage de fum√©e.", "#e74c3c");
        log("(La r√©ponse √©tait : " + solution + ")");
    }
}

function event_donjon() {
    log("üè∞ Tu d√©couvres l'entr√©e d'un donjon myst√©rieux...");
    log("Des bruits inqui√©tants r√©sonnent depuis les profondeurs.");
    log("Un combat difficile t'attend, mais le tr√©sor pourrait √™tre immense !");
    let choix = confirm("Entrer dans le donjon ?");
    if(!choix) {
        log("‚Üí Tu pr√©f√®res √©viter le danger. Parfois, la sagesse vaut mieux que la bravoure.", "#95a5a6");
        return;
    }
    
    let mult = diffSetting.enemy;
    if(jour >= 30) mult *= 6;
    else if(jour >= 20) mult *= 4;
    else if(jour >= 10) mult *= 2;
    
    let ennemiDonjon = {
        nom: jour >= 30 ? "ULTRA Gardien du donjon" : jour >= 20 ? "SUPER Gardien du donjon" : jour >= 10 ? "√âlite Gardien du donjon" : "Gardien du donjon",
        pv: 300 * mult,
        att: 50 * mult,
        def: Math.max(0.1, 0.6 / (jour >= 10 ? 2 : 1)),
        or: 20 * diffSetting.gold
    };
    
    log("‚Üí Tu descends dans les profondeurs...");
    if(combat(ennemiDonjon)) {
        log("üéÅ Le donjon r√©v√®le ses tr√©sors !", "#f1c40f");
        loot_du_jour();
        loot_du_jour();
    }
}

function event_marchand_ambulant() {
    log("üé™ En traversant un village, tu aper√ßois un marchand ambulant excentrique !");
    log("Sa carriole d√©borde d'objets √©tranges et de reliques myst√©rieuses.");
    log("'Ah, un aventurier ! J'ai exactement ce qu'il te faut !' dit-il avec un sourire.");
    
    const allItems = [...oMarchandExclusif, ...oRares, ...oLeg, ...oIntel];
    const stock = [];
    
    // Premier objet garanti
    if(allItems.length > 0) {
        stock.push(choice(allItems));
    }
    
    // 40% de chance d'avoir un 2√®me objet
    if(randint(1, 100) <= 40 && allItems.length > 0) {
        stock.push(choice(allItems));
    }
    
    // 1% de chance d'avoir un 3√®me objet
    if(randint(1, 100) <= 1 && allItems.length > 0) {
        stock.push(choice(allItems));
        log("‚Üí Le marchand est de tr√®s bonne humeur aujourd'hui !", "#f1c40f");
    }
    
    log("‚Üí Le marchand te DONNE g√©n√©reusement " + stock.length + " objet" + (stock.length > 1 ? "s" : "") + " !", "#2ecc71");
    
    stock.forEach(obj => {
        appliquer_objet(obj);
    });
    
    updateUI();
}

// ======================
// MARCHAND (fin de journ√©e)
// ======================
function genererMarchand() {
    const probas = [
        [oCommuns, 1000], 
        [oCommuns, 700], 
        [oRares, 400],
        [oLeg, 40], 
        [oUltra, 15], 
        [oIntel, 50 ], 
        [oCheat, 3]
    ];
    
    let stock = [];
    probas.forEach(([pool, chance]) => {
        if(randint(1, 1000) <= chance && pool.length > 0) {
            stock.push(choice(pool));
        }
    });
    
    return stock;
}

// ======================
// COMBAT
// ======================
function combat(eBase, isBoss = false) {
    const m = isBoss ? diffSetting.boss : diffSetting.enemy;
    let en = { 
        nom: eBase.nom, 
        pv: eBase.pv * m, 
        att: eBase.att * m, 
        def: eBase.def, 
        or: eBase.or * diffSetting.gold,
        gemmes: eBase.gemmes || 0
    };
    
    log("‚öîÔ∏è COMBAT : " + en.nom, "#e74c3c");
    let pvE = en.pv;
    let inv = joueur.capas.includes("invincible_3tour") ? 3 : 0;
    if (joueur.capas.includes("phase") && randint(1,5) === 1) {
        pvE -= 999999;
        log("coup critique : capa phase active");
    }
    while(joueur.pv > 0 && pvE > 0) {
        if(pvE > 0) {
            let sub = en.att * joueur.def;
            if(joueur.capas.includes("reduc_degats")) sub /= 2;
            if(inv > 0) { sub = 0; inv--; }
            if(joueur.capas.includes("reflect_50")) {
                pvE -= (sub * 0.5);
            }
            joueur.pv -= sub;
        }
        
        if(joueur.pv <= 0) break;
        
        let atks = 1;
        if(joueur.capas.includes("multi_attaque")) { 
            while(randint(1, 3) === 1) atks++; 
        }

        for(let i=0; i<atks; i++) {
            let d = joueur.att * en.def;
            if(joueur.intelligence > jour * 2.5) {
                d *= (joueur.intelligence / jour * 2);
            }
            if(joueur.capas.includes("raisonnement") && joueur.intelligence >= jour*1.5) {
                d *= 2;
            }
            if(joueur.capas.includes("extermination") && randint(1,2) === 1) {
                pvE -= 250;
            }
            if(joueur.capas.includes("crit_25") && randint(1, 4) === 1) {
                d *= 5;
            }
            pvE -= d;
            if(joueur.capas.includes("vol_de_vie")) {
                joueur.pv += (d * 0.05);
            }
            if(pvE <= 0) break;
        }
    }

    if(joueur.pv > 0) {
        log("üèÜ Victoire !", "#2ecc71");
        if(en.gemmes) {
            joueur.gemmes += en.gemmes;
            localStorage.setItem('pixelquest_gemmes', joueur.gemmes.toString());
            log("‚Üí +" + en.gemmes + " üíé gemmes r√©cup√©r√©es", "#9b59b6");
        }
        log("‚Üí +" + Math.floor(en.or) + " or r√©cup√©r√©s", "#f1c40f");
        log("‚Üí +" + Math.floor(joueur.regen) + " PV r√©g√©n√©r√©s", "#2ecc71");
        joueur.or += en.or; 
        joueur.pv += joueur.regen;
        updateUI();
        return true;
    }
    
    log("üíÄ D√âFAITE - Tu es tomb√© au combat...", "#ff0000");
    const btn = document.getElementById('btn-next');
    btn.innerText = "üíÄ RECOMMENCER";
    btn.onclick = () => location.reload();
    btn.disabled = false;
    return false;
}

// ======================
// EVENTS POSSIBLES
// ======================
function ennemi_boss(e) {
    return {
        nom: "Boss " + e.nom,
        pv: Math.floor(e.pv * 8),
        att: Math.floor(e.att * 8),
        def: Math.max(0.1, e.def / 2.5),
        or: Math.floor(e.or * 1.5),
        gemmes: e.gemmes || 0
    };
}

function getEventsPossibles() {
    let mag = ennemisBase.mage;
    let ber = ennemisBase.berserker;
    let pal = ennemisBase.paladin;
    let necro = ennemisBase.necromancien;
    let ass = ennemisBase.assassin;
    let vol = ennemisBase.voleur;
    let gue = ennemisBase.guerrier;
    let cha = ennemisBase.champion;
    let drag = ennemisBase.dragon;
    let tit = ennemisBase.titan;
    let crea = ennemisBase.creature;
    let dem =  ennemisBase.demon;

    if(jour >= 40) {
        vol = ennemi_boss(vol);
        gue = ennemi_boss(gue);
        cha = ennemi_boss(cha);
        pal = ennemi_boss(pal);
        necro = ennemi_boss(necro);
        ass = ennemi_boss(ass);
        ber = ennemi_boss(ber);
        mag = ennemi_boss(mag);
        drag = ennemi_boss(drag);
        tit = ennemi_boss(tit);
        crea = ennemi_elite2(crea);
        dem = ennemi_elite(dem);
    } else if(jour >= 30) {
        vol = ennemi_elite3(vol);
        gue = ennemi_elite3(gue);
        cha = ennemi_elite3(cha);
        pal = ennemi_elite3(pal);
        necro = ennemi_elite3(necro);
        ass = ennemi_elite3(ass);
        ber = ennemi_elite3(ber);
        mag = ennemi_elite3(mag);
        drag = ennemi_elite3(drag);
        tit = ennemi_elite3(tit);
        crea = ennemi_elite(crea);
        
    } else if(jour >= 20) {
        vol = ennemi_elite2(vol);
        gue = ennemi_elite2(gue);
        cha = ennemi_elite2(cha);
        pal = ennemi_elite2(pal);
        necro = ennemi_elite2(necro);
        ass = ennemi_elite2(ass);
        ber = ennemi_elite2(ber);
        mag = ennemi_elite2(mag);
        drag = ennemi_elite2(drag);
        tit = ennemi_elite2(tit);
    } else if(jour >= 10) {
        vol = ennemi_elite(vol);
        gue = ennemi_elite(gue);
        cha = ennemi_elite(cha);
        pal = ennemi_elite(pal);
        necro = ennemi_elite(necro);
        ass = ennemi_elite(ass);
        ber = ennemi_elite(ber);
        mag = ennemi_elite(mag);
    }

    let events = [
        () => combat(vol),
        () => combat(vol),
        () => combat(gue),
        () => combat(vol),
        () => combat(gue),
        () => combat(gue),
        event_gain,
        event_gain,
        event_gain_plus,
        event_rencontre,
        event_rencontre,
        event_pari,
        event_pari,
        event_pari_plus,
        event_piege_plus,
        event_piege,
        event_piege,
        event_coffre,
        event_coffre_plus,
        event_chemin,
        event_chemin,
        jackpot,
        event_donjon,
        event_marchand_ambulant,
        event_enigme,
        event_bibliotheque,
        event_enigme,
        event_bibliotheque,
        event_auberge,
        event_gemmes,
        event_gemmes_plus,
        event_incroyable,
    ];

    if(jour >= 5) {
        events.push(
            () => combat(cha),
            () => combat(mag),
            () => combat(pal),
            () => combat(necro),
            () => combat(ber),
            () => combat(ass),
            () => combat(ass),
            () => combat(ber),
            () => combat(pal),
            () => combat(cha)
        );
    }

    if(jour >= 10) {
        events.push(() => combat(drag));
        events.push(() => combat(tit));
    }
    
    if(jour>= 20) {
        events.push(() => combat(crea));
    }

    if(jour>= 30) {
        events.push(() => combat(dem));
    }

    return events;
}

// ======================
// CYCLE DE JEU
// ======================
function toggleBoutique(show) {
    if(show) {
        window.open('boutique.html', 'Boutique', 'width=900,height=700');
    }
}
function playTurn() {
    document.getElementById('btn-next').disabled = true;
    log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ JOUR " + jour + " ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "#f1c40f");
    
    if(joueur.capas.includes("ia")) {
        joueur.intelligence += 2;
        log("üß† Capacit√© IA active : +2 Intelligence", "#9b59b6");
    }
    
    if(joueur.capas.includes("investissement") && randint(1,2) === 1) {
        joueur.or += 20;
        log("üíº Capacit√© Investissement : +30 or", "#f1c40f");
    }
    
    if(joueur.capas.includes("alchimie") && randint(1,4) === 1) {
        joueur.or += 25;
        log("üíé Capacit√© Alchimie : +25 or", "#f1c40f");
    }

    loot_du_jour();
    
    if(joueur.capas.includes("loot+") && randint(1,4) <= 3) {
        log("üéÅ Capacit√© Loot+ activ√©e !", "#e67e22");
        loot_du_jour();
    }

    if(joueur.pv <= 0) return;

    if(jour === 10) {
        log("üö® BOSS APPARA√éT : Seigneur de fer !", "#8e44ad");
        if(!combat(ennemisBase.boss10, true)) return;
    } else if(jour === 20) {
        log("üö® BOSS APPARA√éT : Roi du Nord !", "#3498db");
        if(!combat(ennemisBase.boss20, true)) return;
    } else if(jour === 30) {
        log("üö® BOSS APPARA√éT : Roi du monde !", "#27ae60");
        if(!combat(ennemisBase.boss30, true)) return;
    } else if(jour === 40) {
        log("üö® BOSS APPARA√éT : Prince solaire !", "#f39c12");
        if(!combat(ennemisBase.boss40, true)) return;
    } else if(jour === 50) {
        log("üö® BOSS APPARA√éT : Roi de la galaxie !", "#9b59b6");
        if(!combat(ennemisBase.boss50, true)) return;
    } else if(jour === 60) {
        log("üö® BOSS FINAL : Dictateur inter-galaxie !", "#e74c3c");
        if(!combat(ennemisBase.boss60, true)) {
            return;
        } else {
            log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "#f1c40f");
            log("üèÜ VICTOIRE TOTALE ! üèÜ", "#f1c40f");
            log("Tu as surv√©cu aux 60 jours les plus dangereux de l'humanit√© !", "#2ecc71");
            log("F√©licitations, tu es une l√©gende !", "#f1c40f");
            log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "#f1c40f");
            const btn = document.getElementById('btn-next');
            btn.innerText = "üéâ REJOUER";
            btn.onclick = () => location.reload();
            btn.disabled = false;
            return;
        }
    } else {
        const events = getEventsPossibles();
        const selectedEvent = choice(events);
        selectedEvent();
    }

    if(joueur.pv <= 0) return;

    if(joueur.pv > 0) {
        document.getElementById('merchant-area').style.display = 'block';
        const mCards = document.getElementById('merchant-cards');
        mCards.innerHTML = "";
        
        const stock = genererMarchand();
        stock.forEach(it => {
            mCards.appendChild(createCard(it, true));
        });
    }
    
    updateUI();
}

function finishDay() {
    document.getElementById('merchant-area').style.display = 'none';
    jour++; 
    updateUI(); 
    document.getElementById('btn-next').disabled = false;
}

// ======================
// CARTE INTERFACE
// ======================
function createCard(obj, isMerchant = false) {
    const card = document.createElement('div');
    const isPossessed = obj.capa && joueur.capas.includes(obj.capa);
    card.className = `item-card rarity-${obj.r} ${isPossessed ? 'possessed-card' : ''}`;
    
    let s = "";
    if(obj.att) s += `‚öîÔ∏è Atk: <span>+${obj.att}</span><br>`;
    if(obj.pv) s += `‚ù§Ô∏è PV: <span>+${obj.pv}</span><br>`;
    if(obj.def) s += `üõ°Ô∏è Def: <span>${obj.def}</span><br>`;
    if(obj.intelligence) s += `üß† Int: <span>+${obj.intelligence}</span><br>`;
    if(obj.regen) s += `‚ú® Reg: <span>+${obj.regen}</span><br>`;

    card.innerHTML = `
        <div class="card-name">${obj.nom}</div>
        <div class="card-stats">${s || '<em style="color:#666">Capacit√© sp√©ciale</em>'}</div>
        ${obj.capa ? `<div class="card-capa">‚òÖ ${obj.capa}</div>` : ''}
        ${isPossessed ? `<div class="owned-tag">‚úì ACQUIS</div>` : ''}
        ${isMerchant ? `<div style="margin-top:10px; color:#f1c40f; font-weight:bold; font-size:0.8em">üí∞ 20 OR</div>` : ''}
    `;

    if(isMerchant) {
        card.style.cursor = 'pointer';
        card.onclick = () => {
            if(joueur.or >= 20) {
                joueur.or -= 20; 
                log("‚Üí Achat : " + obj.nom + " pour 20 or", "#3498db");
                appliquer_objet(obj); 
                card.style.opacity = "0.3"; 
                card.style.cursor = "not-allowed";
                card.onclick = null;
            } else {
                log("‚ùå Pas assez d'or ! (Il te faut 20 or)", "#e74c3c");
            }
        };
    }
    
    return card;
}

function renderCodex() {
    const grid = document.getElementById('codex-grid');
    grid.innerHTML = "";
    
    const categories = [
        {title: "COMMUNS", items: oCommuns, color: "#95a5a6"},
        {title: "RARES", items: oRares, color: "#3498db"},
        {title: "L√âGENDAIRES", items: oLeg, color: "#f1c40f"},
        {title: "ULTRA", items: oUltra, color: "#9b59b6"},
        {title: "INTELLIGENCE", items: oIntel, color: "#2ecc71"},
        {title: "MARCHAND EXCLUSIF", items: oMarchandExclusif, color: "#e67e22"},
        {title: "CHEAT", items: oCheat, color: "#e74c3c"}
    ];
    
    categories.forEach(cat => {
        const section = document.createElement('div');
        section.style.width = '100%';
        section.style.marginBottom = '30px';
        section.innerHTML = `<h2 style="color:${cat.color}; border-bottom: 2px solid ${cat.color}; padding-bottom: 10px;">${cat.title}</h2>`;
        
        const cardsDiv = document.createElement('div');
        cardsDiv.className = 'cards-container';
        cardsDiv.style.marginTop = '15px';
        
        cat.items.forEach(item => {
            cardsDiv.appendChild(createCard(item, false));
        });
        
        section.appendChild(cardsDiv);
        grid.appendChild(section);
    });
}

function toggleCodex(show) {
    const overlay = document.getElementById('codex-overlay');
    if(show) {
        document.getElementById('my-capas-list').innerText = 
            joueur.capas.length > 0 ? joueur.capas.join(", ") : "Aucune";
        switchCodexTab('objets');
        overlay.style.display = 'block';
    } else {
        overlay.style.display = 'none';
    }
}

function switchCodexTab(tab) {
    const tabObjets = document.getElementById('tab-objets');
    const tabEvents = document.getElementById('tab-events');
    const contentObjets = document.getElementById('codex-objets-content');
    const contentEvents = document.getElementById('codex-events-content');
    
    if(tab === 'objets') {
        tabObjets.style.background = 'var(--accent)';
        tabObjets.style.color = '#000';
        tabObjets.style.borderColor = 'var(--accent)';
        tabEvents.style.background = '#000';
        tabEvents.style.color = '#fff';
        tabEvents.style.borderColor = '#fff';
        
        contentObjets.style.display = 'block';
        contentEvents.style.display = 'none';
        renderCodex();
    } else {
        tabEvents.style.background = 'var(--accent)';
        tabEvents.style.color = '#000';
        tabEvents.style.borderColor = 'var(--accent)';
        tabObjets.style.background = '#000';
        tabObjets.style.color = '#fff';
        tabObjets.style.borderColor = '#fff';
        
        contentObjets.style.display = 'none';
        contentEvents.style.display = 'block';
        renderEventsCodex();
    }
}

function renderEventsCodex() {
    const grid = document.getElementById('events-grid');
    grid.innerHTML = "";
    grid.style.display = 'flex';
    grid.style.flexWrap = 'wrap';
    grid.style.gap = '15px';
    grid.style.justifyContent = 'center';
    
    const eventsData = [
        {
            nom: "Voleur",
            desc: "Ennemi rapide",
            icon: "üó°Ô∏è",
            stats: "PV: 60 | Att: 6 | Def: 2 | Or: 10",
            proba: "Tr√®s Fr√©quent",
            color: "#e74c3c"
        },
        {
            nom: "Guerrier",
            desc: "√âquilibr√©",
            icon: "‚öîÔ∏è",
            stats: "PV: 100 | Att: 8 | Def: 1.8 | Or: 20",
            proba: "Tr√®s Fr√©quent",
            color: "#e74c3c"
        },
        {
            nom: "Assassin",
            desc: "Frappe fort",
            icon: "üî™",
            stats: "PV: 80 | Att: 15 | Def: 2 | Or: 20",
            proba: "Fr√©quent",
            color: "#e74c3c"
        },
        {
            nom: "Mage noir",
            desc: "Attaque magique",
            icon: "üîÆ",
            stats: "PV: 100 | Att: 30 | Def: 1 | Or: 30",
            proba: "J5+ Fr√©quent",
            color: "#9b59b6"
        },
        {
            nom: "Berserker",
            desc: "Tank agressif",
            icon: "ü™ì",
            stats: "PV: 120 | Att: 15 | Def: 1.5 | Or: 20",
            proba: "J5+ Fr√©quent",
            color: "#c0392b"
        },
        {
            nom: "N√©cromancien",
            desc: "Magie noire",
            icon: "üíÄ",
            stats: "PV: 200 | Att: 20 | Def: 1 | Or: 30",
            proba: "J5+ Fr√©quent",
            color: "#8e44ad"
        },
        {
            nom: "Paladin corrompu",
            desc: "D√©fense √©lev√©e",
            icon: "üõ°Ô∏è",
            stats: "PV: 250 | Att: 10 | Def: 0.6 | Or: 20",
            proba: "J5+ Fr√©quent",
            color: "#34495e"
        },
        {
            nom: "Champion",
            desc: "Fort (J5+)",
            icon: "üëë",
            stats: "PV: 200 | Att: 20 | Def: 1.5 | Or: 30",
            proba: "J5+ Fr√©quent",
            color: "#c0392b"
        },
        {
            nom: "Dragon sauvage",
            desc: "Cr√©ature mythique",
            icon: "üêâ",
            stats: "PV: 400 | Att: 40 | Def: 1.2 | Or: 40",
            proba: "J10+ Rare",
            color: "#e74c3c"
        },
        {
            nom: "Titan de pierre",
            desc: "Colosse antique",
            icon: "üóø",
            stats: "PV: 500 | Att: 35 | Def: 0.8 | Or: 40",
            proba: "J10+ Rare",
            color: "#95a5a6"
        },
        {
            nom: "Cr√©ature d√©moniaque",
            desc: "Animal des d√©mons",
            icon: "ü¶á",
            stats: "PV: 1000 | Att: 100 | Def: 0.5 | Or: 50",
            proba: "J20+ Rare",
            color: "#d63031",
        },
        {
            nom: "D√©mon",
            desc: "Ce que tu n'as pas envie de recontrer",
            icon: "üëπ",
            stats: "PV: 1500 | Att: 150 | Def: 0.5 | Or: 60",
            proba: "J30+ Rare",
            color: "#c0392b",
        },
        {
            nom: "Boss J10",
            desc: "Seigneur de fer",
            icon: "üëë",
            stats: "PV: 450 | Att: 25 | Or: 30",
            proba: "J10",
            color: "#8e44ad"
        },
        {
            nom: "Boss J20",
            desc: "Roi du Nord",
            icon: "‚ùÑÔ∏è",
            stats: "PV: 2500 | Att: 80 | Or: 40",
            proba: "J20",
            color: "#3498db"
        },
        {
            nom: "Boss J30",
            desc: "Roi du monde",
            icon: "üåç",
            stats: "PV: 5500 | Att: 250 | Or: 60",
            proba: "J30",
            color: "#27ae60"
        },
        {
            nom: "Boss J40",
            desc: "Prince solaire",
            icon: "‚òÄÔ∏è",
            stats: "PV: 12000 | Att: 450 | Or: 80",
            proba: "J40",
            color: "#f39c12"
        },
        {
            nom: "Boss J50",
            desc: "Roi galactique",
            icon: "üåå",
            stats: "PV: 20000 | Att: 600 | Or: 90",
            proba: "J50",
            color: "#9b59b6"
        },
        {
            nom: "Boss J60",
            desc: "Dictateur inter-galaxie",
            icon: "üåë",
            stats: "PV: 35000 | Att: 900 | Or: 100",
            proba: "J50",
            color: "#9b59b6"
        },
        {
            nom: "Auberge",
            desc: "Repos payant ou gratuit",
            icon: "üè†",
            stats: "10 or = +30 PV | Gratuit = +10 PV",
            proba: "Fr√©quent",
            color: "#2ecc71"
        },
        {
            nom: "Biblioth√®que",
            desc: "Savoir contre sant√©",
            icon: "üìö",
            stats: "-15 PV pour +3 Intelligence",
            proba: "Courant",
            color: "#9b59b6"
        },
        {
            nom: "√ânigme",
            desc: "Test d'intelligence",
            icon: "üß©",
            stats: "Bonne r√©ponse: +20 or +2 Int",
            proba: "Courant",
            color: "#3498db"
        },
        {
            nom: "Donjon",
            desc: "Combat dur, gros loot",
            icon: "üè∞",
            stats: "Gardien (PV:300 Att:50) loot",
            proba: "Rare",
            color: "#8e44ad"
        },
        {
            nom: "Marchand ambulant",
            desc: "Objets exclusifs !",
            icon: "üé™",
            stats: "1 objet exclusif + objets rares",
            proba: "Rare",
            color: "#e67e22"
        },
        {
            nom: "Pi√®ge",
            desc: "D√©g√¢ts √©vitables",
            icon: "‚ö†Ô∏è",
            stats: "Jour√ó2 d√©g√¢ts | Int‚â•Jour: +10 or",
            proba: "Courant",
            color: "#e67e22"
        },
        {
            nom: "Pi√®ge +",
            desc: "Dangereux",
            icon: "‚ö†Ô∏è‚ö†Ô∏è",
            stats: "Jour√ó4 d√©g√¢ts | Int‚â•Jour√ó2: +20 or",
            proba: "Rare",
            color: "#d35400"
        },
        {
            nom: "Or",
            desc: "Trouvaille",
            icon: "üí∞",
            stats: "+10 or",
            proba: "Courant",
            color: "#f1c40f"
        },
        {
            nom: "Or bonus",
            desc: "Belle trouvaille",
            icon: "üí∞üí∞",
            stats: "+20 or",
            proba: "Courant",
            color: "#f39c12"
        },
        {
            nom: "Repos",
            desc: "Rencontre paisible",
            icon: "üòä",
            stats: "+10 PV",
            proba: "Courant",
            color: "#2ecc71"
        },
        {
            nom: "3 chemins",
            desc: "Choix strat√©gique",
            icon: "üõ§Ô∏è",
            stats: "Loot / +20 or / Rien",
            proba: "Courant",
            color: "#3498db"
        },
        {
            nom: "Coffre",
            desc: "Loot standard",
            icon: "üì¶",
            stats: "Commun/Rare/L√©gendaire",
            proba: "Courant",
            color: "#95a5a6"
        },
        {
            nom: "Coffre rare",
            desc: "Loot premium",
            icon: "üì¶‚ú®",
            stats: "Rare/L√©gendaire/Ultra",
            proba: "Rare",
            color: "#9b59b6"
        },
        {
            nom: "Pari",
            desc: "50/50",
            icon: "üé≤",
            stats: "+20 or / -10 or",
            proba: "Courant",
            color: "#e74c3c"
        },
        {
            nom: "Pari +",
            desc: "75% succ√®s",
            icon: "üé≤‚ú®",
            stats: "75% +20 or / 25% -10 or",
            proba: "rare",
            color: "#c0392b"
        },
        {
            nom: "JACKPOT",
            desc: "Tr√©sor l√©gendaire",
            icon: "üèÜ",
            stats: "+40 or",
            proba: "Rare",
            color: "#f1c40f"
        },
        {
            nom: "RUINE ANCESTRALE",
            desc: "Tr√©sor le plus pr√©cieux",
            icon: "‚ú®",
            stats: "30 or, 20 gemmes, coffre rare si tu as de la chance",
            proba: "rare",
            color: "#f1c40f"
        }
    ];
    
    eventsData.forEach(ev => {
        const card = document.createElement('div');
        card.style.background = 'var(--card-bg)';
        card.style.border = '2px solid #333';
        card.style.padding = '10px';
        card.style.width = '180px';
        card.style.minHeight = '180px';
        card.style.display = 'flex';
        card.style.flexDirection = 'column';
        card.style.transition = 'all 0.3s ease';
        
        card.innerHTML = `
            <div style="font-size: 2em; text-align: center; margin-bottom: 8px;">${ev.icon}</div>
            <div style="font-weight: bold; color: ${ev.color}; border-bottom: 1px solid #333; padding-bottom: 4px; margin-bottom: 8px; font-size: 0.85em;">
                ${ev.nom}
            </div>
            <div style="font-size: 0.7em; color: #bbb; margin-bottom: 6px; line-height: 1.3;">
                ${ev.desc}
            </div>
            <div style="font-size: 0.65em; color: #fff; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 3px; margin-bottom: 6px; flex-grow: 1;">
                ${ev.stats}
            </div>
            <div style="font-size: 0.6em; color: #f1c40f; font-style: italic;">
                üìä ${ev.proba}
            </div>
        `;
        
        card.onmouseover = () => {
            card.style.borderColor = ev.color;
            card.style.boxShadow = `0 0 15px ${ev.color}`;
            card.style.transform = 'translateY(-5px)';
        };
        card.onmouseout = () => {
            card.style.borderColor = '#333';
            card.style.boxShadow = 'none';
            card.style.transform = 'translateY(0)';
        };
        
        grid.appendChild(card);
    });
}
// √âcouter les messages de la boutique
window.addEventListener('message', function(event) {
    if(event.data.type === 'upgrade_bought') {
        log("üíé Am√©lioration achet√©e : " + event.data.stat.toUpperCase() + " +" + event.data.bonus, "#9b59b6");
        
        // Recharger les donn√©es depuis localStorage
        permanentUpgrades = JSON.parse(localStorage.getItem('pixelquest_upgrades'));
        upgradesCost = JSON.parse(localStorage.getItem('pixelquest_costs'));
        joueur.gemmes = parseInt(localStorage.getItem('pixelquest_gemmes'));
        
        updateUI();
    }
});
    // ======================
// COLLECTION D'OBJETS
// ======================
let selectedCollectionItems = [];

function openCollection() {
    // Recharger la s√©lection depuis localStorage
    loadSelectedItems();
    
    document.getElementById('collection-overlay').style.display = 'block';
    renderCollection();
}
function closeCollection() {
    document.getElementById('collection-overlay').style.display = 'none';
}

function renderCollection() {
    const grid = document.getElementById('collection-grid');
    grid.innerHTML = '';
    
    const inventory = JSON.parse(localStorage.getItem('pixelquest_inventory') || '[]');
    
    // Compter les objets par nom
    const itemCounts = {};
    inventory.forEach(item => {
        itemCounts[item.nom] = (itemCounts[item.nom] || 0) + 1;
    });
    
    // Cr√©er un set de tous les objets possibles
    const allPossibleItems = [...oCommuns, ...oRares, ...oLeg, ...oUltra, ...oIntel, ...oCheat];
    
    // Grouper par raret√©
    const categories = [
        {title: "COMMUNS", items: oCommuns, color: "#95a5a6"},
        {title: "RARES", items: oRares, color: "#3498db"},
        {title: "INTELLIGENCE", items: oIntel, color: "#2ecc71"},
        {title: "L√âGENDAIRES", items: oLeg, color: "#f1c40f"},
        {title: "ULTRA", items: oUltra, color: "#9b59b6"},
        {title: "CHEAT", items: oCheat, color: "#e74c3c"}
    ];
    
    categories.forEach(cat => {
        const section = document.createElement('div');
        section.style.width = '100%';
        section.style.marginBottom = '30px';
        section.innerHTML = `<h2 style="color:${cat.color}; border-bottom: 2px solid ${cat.color}; padding-bottom: 10px;">${cat.title}</h2>`;
        
        const cardsDiv = document.createElement('div');
        cardsDiv.className = 'cards-container';
        cardsDiv.style.marginTop = '15px';
        
        cat.items.forEach(item => {
            const count = itemCounts[item.nom] || 0;
            const maxCount = ["commun", "rare", "intel"].includes(item.r) ? 3 : 1;
            
            // Cr√©er les emplacements
            for(let i = 0; i < maxCount; i++) {
                const card = createCollectionCard(item, i < count, i);
                cardsDiv.appendChild(card);
            }
        });
        
        section.appendChild(cardsDiv);
        grid.appendChild(section);
    });
    
    updateCollectionCount();
}

function createCollectionCard(item, isOwned, slotIndex) {
    const card = document.createElement('div');
    const itemKey = `${item.nom}-${slotIndex}`;
    const isSelected = selectedCollectionItems.some(sel => sel.key === itemKey);
    
    card.className = `collection-card rarity-${item.r}`;
    if(isOwned) card.classList.add('owned');
    if(isSelected) card.classList.add('selected');
    
    let stats = '';
    if(item.att) stats += `‚öîÔ∏è Atk: <span>+${item.att}</span><br>`;
    if(item.pv) stats += `‚ù§Ô∏è PV: <span>+${item.pv}</span><br>`;
    if(item.def) stats += `üõ°Ô∏è Def: <span>${item.def}</span><br>`;
    if(item.intelligence) stats += `üß† Int: <span>+${item.intelligence}</span><br>`;
    if(item.regen) stats += `‚ú® Reg: <span>+${item.regen}</span><br>`;
    
    card.innerHTML = `
        ${isSelected ? '<div class="selected-indicator">‚úì</div>' : ''}
        ${isOwned && !isSelected ? `<div class="card-count">${slotIndex + 1}</div>` : ''}
        <div class="card-name">${item.nom}</div>
        <div class="card-stats">${stats || '<em style="color:#666">Capacit√© sp√©ciale</em>'}</div>
        ${item.capa ? `<div class="card-capa">‚òÖ ${item.capa}</div>` : ''}
    `;
    
    if(isOwned) {
        card.onclick = () => toggleCollectionSelection(item, itemKey);
    }
    
    return card;
}

function toggleCollectionSelection(item, itemKey) {
    const index = selectedCollectionItems.findIndex(sel => sel.key === itemKey);
    
    if(index > -1) {
        // D√©s√©lectionner
        selectedCollectionItems.splice(index, 1);
    } else {
        // S√©lectionner
        if(selectedCollectionItems.length >= 3) {
            alert('Tu peux s√©lectionner maximum 3 objets !');
            return;
        }
        selectedCollectionItems.push({ key: itemKey, item: item });
    }
    
    // SAUVEGARDER dans localStorage
    const items = selectedCollectionItems.map(sel => sel.item);
    localStorage.setItem('pixelquest_selected_items', JSON.stringify(items));
    
    renderCollection();
}

function updateCollectionCount() {
    const count = selectedCollectionItems.length;
    document.getElementById('collection-selected-count').innerText = count;
    document.getElementById('selected-count').innerText = count;
}

function startWithSelectedItems() {
    // Sauvegarder les objets s√©lectionn√©s
    const items = selectedCollectionItems.map(sel => sel.item);
    localStorage.setItem('pixelquest_selected_items', JSON.stringify(items));
    
    // Fermer la collection et afficher le menu de difficult√©
    closeCollection();
    
    // Si aucun objet s√©lectionn√©, message optionnel
    if(items.length === 0) {
        const confirm = window.confirm("Tu n'as s√©lectionn√© aucun objet. Commencer quand m√™me ?");
        if(!confirm) return;
    }
}
</script>
    <div id="collection-overlay">
        <div style="display:flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px;">
            <h1 style="margin:0; color:var(--accent);">üì¶ COLLECTION D'OBJETS</h1>
            <button class="btn" onclick="closeCollection()">FERMER ‚úñ</button>
        </div>
        
        <p style="color: #bbb; margin-bottom: 20px; text-align: center;">
            S√©lectionne jusqu'√† 3 objets pour commencer ta partie. Les cartes gris√©es n'ont pas encore √©t√© obtenues.
        </p>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <span style="color: var(--accent); font-size: 1.2em; font-weight: bold;">
                Objets s√©lectionn√©s : <span id="collection-selected-count">0</span> / 3
            </span>
        </div>
        
        <div id="collection-grid" class="cards-container" style="margin-bottom: 30px;"></div>
        
        <div style="text-align: center;">
            <button class="btn" onclick="closeCollection()" style="font-size: 1.2em; padding: 15px 40px; border-color: var(--accent); color: var(--accent);">
                SAUVEGARDER ET FERMER ‚úì
            </button>
        </div>
    </div>

</body>
</html>

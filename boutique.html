<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PIXEL QUEST - Boutique</title>
    <style>
        :root {
            --bg-color: #08080c;
            --card-bg: #111116;
        }
        body {
            background-color: var(--bg-color);
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            padding: 40px;
            margin: 0;
            user-select: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            color: #9b59b6;
        }
        .btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        .btn:hover {
            background: #fff;
            color: #000;
        }
        .info-box {
            background: rgba(155, 89, 182, 0.1);
            border: 1px solid #9b59b6;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #9b59b6;
        }
        .info-box p {
            margin: 0;
            font-size: 0.85em;
            color: #bbb;
        }
        .upgrades-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .upgrade-card {
            background: var(--card-bg);
            border: 2px solid #9b59b6;
            padding: 15px;
            width: 220px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .upgrade-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px #9b59b6;
        }
        .upgrade-icon {
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
        }
        .upgrade-label {
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .upgrade-current {
            text-align: center;
            color: #bbb;
            font-size: 0.75em;
            margin-bottom: 10px;
        }
        .upgrade-next {
            text-align: center;
            color: #fff;
            font-size: 0.8em;
            margin-bottom: 15px;
        }
        .upgrade-btn {
            width: 100%;
            border-color: #9b59b6;
            color: #9b59b6;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ’Ž BOUTIQUE PERMANENTE</h1>
        <button class="btn" onclick="window.close()">FERMER âœ–</button>
    </div>

    <p style="color: #bbb; margin-bottom: 20px;">
        AmÃ©liore tes statistiques de dÃ©part ! Ces amÃ©liorations sont permanentes et persistent aprÃ¨s la mort.
    </p>

    <div class="info-box">
        <h3>ðŸ’Ž Tes Gemmes: <span id="gemmes-display">0</span></h3>
        <p>Obtenez des gemmes en battant les Boss et les ennemis Dragon/Titan</p>
    </div>

<div class="upgrades-container" id="upgrades-container"></div>
    <hr style="border: 0; border-top: 2px solid #9b59b6; margin: 40px 0;">
    
    <h2 style="color: #9b59b6; text-align: center; margin-bottom: 20px;">ðŸ“¦ COFFRES MYSTÃ‰RIEUX</h2>
    <p style="color: #bbb; margin-bottom: 20px; text-align: center;">
        Ouvre des coffres pour obtenir des objets alÃ©atoires Ã  utiliser en dÃ©but de partie !
    </p>
    
    <div style="text-align: center; margin-bottom: 30px;">
        <div style="background: rgba(155, 89, 182, 0.1); border: 1px solid #9b59b6; padding: 20px; display: inline-block; border-radius: 5px;">
            <div style="font-size: 3em; margin-bottom: 10px;">ðŸ“¦</div>
            <div style="font-size: 1.2em; margin-bottom: 10px; color: #fff;">Coffre MystÃ©rieux</div>
            <div style="font-size: 0.85em; color: #bbb; margin-bottom: 15px;">
                50% Commun | 22% Rare | 20% Intel<br>
                5.5% LÃ©gendaire | 2% Ultra | 0.5% Cheat
            </div>
            <button class="btn" id="btn-buy-chest" onclick="buyChest()" style="border-color: #9b59b6; color: #9b59b6; font-size: 1.1em;">
                ðŸ’Ž <span id="chest-cost">10</span> Gemmes
            </button>
        </div>
    </div>
    
    <div id="chest-result" style="text-align: center; margin-top: 20px; min-height: 50px;"></div>

    <script>
        // Chargement des donnÃ©es depuis localStorage
        let permanentUpgrades = JSON.parse(localStorage.getItem('pixelquest_upgrades') || '{"pv":0,"att":0,"def":0,"or":0,"regen":0}');
        let upgradesCost = JSON.parse(localStorage.getItem('pixelquest_costs') || '{"pv":10,"att":10,"def":10,"or":10,"regen":10}');
        let gemmes = parseInt(localStorage.getItem('pixelquest_gemmes') || '0');
        let chestCost = parseInt(localStorage.getItem('pixelquest_chest_cost') || '10');
        let inventory = JSON.parse(localStorage.getItem('pixelquest_inventory') || '[]');

        // Configuration des amÃ©liorations
        const upgrades = [
            {stat: 'pv', label: 'PV MAX', icon: 'â¤ï¸', bonus: 10, color: '#e74c3c'},
            {stat: 'att', label: 'ATTAQUE', icon: 'âš”ï¸', bonus: 5, color: '#f39c12'},
            {stat: 'or', label: 'OR DE DÃ‰PART', icon: 'ðŸ’°', bonus: 5, color: '#f1c40f'},
            {stat: 'def', label: 'DÃ‰FENSE', icon: 'ðŸ›¡ï¸', bonus: 0.1, color: '#3498db'},
            {stat: 'regen', label: 'RÃ‰GÃ‰NÃ‰RATION', icon: 'âœ¨', bonus: 2, color: '#2ecc71'}
        ];

        function renderBoutique() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = '';
            
            document.getElementById('gemmes-display').innerText = gemmes;
            document.getElementById('chest-cost').innerText = chestCost; 

            upgrades.forEach(up => {
                const card = document.createElement('div');
                card.className = 'upgrade-card';
                
                const currentBonus = permanentUpgrades[up.stat];
                const cost = upgradesCost[up.stat];
                
                card.innerHTML = `
                    <div class="upgrade-icon">${up.icon}</div>
                    <div class="upgrade-label" style="color: ${up.color};">
                        ${up.label}
                    </div>
                    <div class="upgrade-current">
                        Stats de dÃ©part: <span style="color: #2ecc71; font-weight: bold;">+${up.stat === 'def' ? (currentBonus * 10) : currentBonus}</span>
                    </div>
                    <div class="upgrade-next">
                        Prochain: <span style="color: ${up.color};">+${up.stat === 'def' ? up.bonus : up.bonus}</span>
                    </div>
                    <button class="btn upgrade-btn" onclick="buyUpgrade('${up.stat}', ${up.bonus})">
                        ðŸ’Ž ${cost} Gemmes
                    </button>
                `;
                
                container.appendChild(card);
            });
        }

        function buyUpgrade(stat, bonus) {
            const cost = upgradesCost[stat];
            
            if(gemmes < cost) {
                alert('Pas assez de gemmes ! Il te faut ' + cost + ' gemmes.');
                return;
            }
            
            gemmes -= cost;
            permanentUpgrades[stat] += (stat === 'def' ? bonus : bonus);
            upgradesCost[stat] += 5;
            
            // Sauvegarder
            localStorage.setItem('pixelquest_upgrades', JSON.stringify(permanentUpgrades));
            localStorage.setItem('pixelquest_costs', JSON.stringify(upgradesCost));
            localStorage.setItem('pixelquest_gemmes', gemmes.toString());
            
            // Notifier le parent si ouvert dans une iframe/popup
            if(window.opener) {
                window.opener.postMessage({type: 'upgrade_bought', stat: stat, bonus: bonus}, '*');
            }
            
            renderBoutique();
        }

        // Ã‰couter les messages du parent pour mise Ã  jour des gemmes
        window.addEventListener('message', function(event) {
            if(event.data.type === 'update_gemmes') {
                gemmes = event.data.gemmes;
                localStorage.setItem('pixelquest_gemmes', gemmes.toString());
                renderBoutique();
            }
        });
        function buyChest() {
            if(gemmes < chestCost) {
                alert('Pas assez de gemmes ! Il te faut ' + chestCost + ' gemmes.');
                return;
            }
            
            gemmes -= chestCost;
            localStorage.setItem('pixelquest_gemmes', gemmes.toString());
            
            // Tirer un objet alÃ©atoire
            const item = getRandomChestItem();
            
            // Ajouter Ã  l'inventaire
            addToInventory(item);
            
            // Augmenter le coÃ»t
            chestCost += 30;
            localStorage.setItem('pixelquest_chest_cost', chestCost.toString());
            
            // Afficher le rÃ©sultat
            displayChestResult(item);
            
            // Mettre Ã  jour l'affichage
            document.getElementById('chest-cost').innerText = chestCost;
            renderBoutique();
            
            // Notifier le parent
            if(window.opener) {
                window.opener.postMessage({type: 'chest_opened', item: item}, '*');
            }
        }
        
        function getRandomChestItem() {
            const allItems = [
                {nom: "Ã‰pÃ©e rouillÃ©e", att: 3, r:"commun"},
                {nom: "Casque simple", pv: 8, r:"commun"},
                {nom: "Anneau magique usÃ©", def: -0.1, r:"commun"},
                {nom: "Lance", att: 4, r:"commun"},
                {nom: "BÃ¢ton magique", att: 2, regen: 1, r:"commun"},
                {nom: "Buff commun", att: 2, pv: 5, def: -0.05, r:"commun"},
                {nom: "Bouclier", def: -0.1, pv: 5, r:"commun"},
                {nom: "Buff evo commun", att: 4, pv: 10, regen: 2, def: -0.1, r:"commun"},
                {nom: "Ã‰pÃ©e fine", att: 8, r:"rare"},
                {nom: "Armure renforcÃ©e", def: -0.2, pv: 10, r:"rare"},
                {nom: "Amulette vitale", pv: 20, r:"rare"},
                {nom: "Anneau de pouvoir", pv: 10, att: 5, r:"rare"},
                {nom: "Colt 1911", att: 10, r:"rare"},
                {nom: "Buff rare", att: 4, pv: 10, def: -0.1, r:"rare"},
                {nom: "M4", att: 18, r:"rare"},
                {nom: "Buff evo rare", att: 8, pv: 20, def: -0.2, regen: 4, r:"rare"},
                {nom: "Livre tactique", att: 8, intelligence: 5, r:"rare"},
                {nom: "Cerveau moisi", intelligence: 1, r:"intel"},
                {nom: "Livre pas ouf", intelligence: 2, r:"intel"},
                {nom: "Livre carrÃ©", intelligence: 5, r:"intel"},
                {nom: "Grimoire qui date", intelligence: 3, r:"intel"},
                {nom: "Livre du savoir", intelligence: 7, r:"intel"},
                {nom: "Lame mythique", att: 95, r:"legendaire"},
                {nom: "Armure enchantÃ©e", pv: 70, def: -0.25, regen: 10, r:"legendaire"},
                {nom: "Coeur du hÃ©ros", pv: 50, capa: "vol_de_vie", r:"legendaire"},
                {nom: "Carapace absolue", pv: 70, capa: "reduc_degats", r:"legendaire"},
                {nom: "Lames frÃ©nÃ©tiques", att: 45, capa: "multi_attaque", r:"legendaire"},
                {nom: "Buff legendaire", att: 30, pv: 50, def: -0.3, regen: 5, r:"legendaire"},
                {nom: "Savoir continu", intelligence: 8, capa: "ia", r:"legendaire"},
                {nom: "Bouclier invincible", pv: 120, def: -0.5, capa: "invincible_3tour", r:"ultra"},
                {nom: "Gantelet de puissance", att: 90, capa: "crit_25", r:"ultra"},
                {nom: "Tenu de camouflage ultime", pv: 80, def: -0.4, capa: "esquive_total", r:"ultra"},
                {nom: "Buff ultime", pv: 125, def: -0.6, att: 50, regen: 15, r:"ultra"},
                {nom: "Source du savoir", intelligence: 12, capa: "raisonnement", r:"ultra"},
                {nom: "Negociant", capa: "investissement", r:"ultra"},
                {nom: "(Mahe) Rat divin", capa: "loot+", r:"cheat"},
                {nom: "Buff divin", pv: 300, att: 150, def: -1, regen: 30, r:"cheat"},
                {nom: "Lumiere divine", att: 100, capa: "extermination", r:"cheat"},
                {nom: "Miroir de l'Ã¢me", capa: "reflect_50", r:"cheat"}
            ];
            
            const rand = Math.random() * 100;
            let rarity;
            
            if(rand < 50) rarity = "commun";
            else if(rand < 72) rarity = "rare";
            else if(rand < 92) rarity = "intel";
            else if(rand < 97.5) rarity = "legendaire";
            else if(rand < 99.5) rarity = "ultra";
            else rarity = "cheat";
            
            const pool = allItems.filter(i => i.r === rarity);
            return pool[Math.floor(Math.random() * pool.length)];
        }
        
        function addToInventory(item) {
            let count = inventory.filter(i => i.nom === item.nom).length;
            let maxCount = ["commun", "rare", "intel"].includes(item.r) ? 3 : 1;
            
            if(count < maxCount) {
                inventory.push(item);
                localStorage.setItem('pixelquest_inventory', JSON.stringify(inventory));
            }
        }
        
        function displayChestResult(item) {
            const colors = {
                commun: "#95a5a6",
                rare: "#3498db",
                intel: "#2ecc71",
                legendaire: "#f1c40f",
                ultra: "#9b59b6",
                cheat: "#e74c3c"
            };
            
            const resultDiv = document.getElementById('chest-result');
            resultDiv.innerHTML = `
                <div style="animation: fadeIn 0.5s; padding: 20px; background: rgba(0,0,0,0.3); border: 2px solid ${colors[item.r]}; border-radius: 10px; display: inline-block;">
                    <div style="font-size: 2em; margin-bottom: 10px;">âœ¨</div>
                    <div style="color: ${colors[item.r]}; font-size: 1.3em; font-weight: bold; margin-bottom: 5px;">
                        ${item.nom}
                    </div>
                    <div style="color: #bbb; font-size: 0.9em; text-transform: uppercase;">
                        ${item.r}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
        }

        // Initialisation
        renderBoutique();
    </script>
</body>
</html>
